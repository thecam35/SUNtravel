<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospedajes Cartagena</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f5f5f5;
        }
        
        header {
            background: #0056b3;
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        nav {
            background: #333;
            padding: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        nav ul li {
            margin: 0 1rem;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #555;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            background-color: white;
            min-height: calc(100vh - 200px);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .property-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .property-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            transition: transform 0.3s, box-shadow 0.3s;
            background-color: white;
        }
        
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .property-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        button {
            background: #0056b3;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #003d7a;
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .logout-btn {
            background: #dc3545;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .property-detail-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .property-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .property-gallery img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        .property-gallery img:hover {
            border-color: #0056b3;
        }

        .property-description {
            white-space: pre-line;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #0056b3;
        }

        .property-info {
            background: #f0f8ff;
            padding: 1.2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #0056b3;
        }

        .property-info p {
            margin: 0.7rem 0;
            display: flex;
        }

        .property-info p strong {
            display: inline-block;
            width: 120px;
            color: #555;
        }

        .reservation-form {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .back-button {
            margin-bottom: 1.5rem;
            background: #6c757d;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .section-title {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .property-card h4 {
            margin: 0.8rem 0;
            color: #0056b3;
        }

        .property-card p {
            margin: 0.5rem 0;
            color: #555;
        }

        .amenities-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .amenity-item {
            display: flex;
            align-items: center;
        }

        .amenity-item input {
            margin-right: 0.5rem;
        }

        .profile-container {
            display: flex;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .profile-sidebar {
            width: 250px;
            background: #f0f8ff;
            padding: 1.5rem;
            border-radius: 8px;
            height: fit-content;
        }

        .profile-content {
            flex: 1;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            display: block;
            border: 3px solid #0056b3;
        }

        .reservations-list {
            margin-top: 1.5rem;
        }

        .reservation-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }

        .reservation-card h4 {
            margin-top: 0;
            color: #0056b3;
        }

        .reservation-status {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .tab-container {
            margin-bottom: 1.5rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #0056b3;
            border-bottom: 3px solid #0056b3;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 1.5rem 0;
        }

        .tab-content.active {
            display: block;
        }

        .user-properties {
            margin-top: 1.5rem;
        }

        .property-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .property-actions button {
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .edit-btn {
            background: #ffc107;
        }

        .delete-btn {
            background: #dc3545;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Estilos para el calendario de disponibilidad */
        .availability-options {
            margin-bottom: 1rem;
        }

        .availability-options label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .calendar-container {
            margin-top: 1rem;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 8px;
        }

        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 0.5rem;
            background: #f0f0f0;
        }

        .calendar-day {
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #f0f8ff;
        }

        .calendar-day.available {
            background: white;
        }

        .calendar-day.unavailable {
            background: #333;
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #f9f9f9;
        }

        .calendar-day.today {
            border: 2px solid #0056b3;
        }

        .availability-note {
            margin-top: 1rem;
            font-size: 0.9em;
            color: #666;
        }

        .availability-display {
            margin-top: 1rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .availability-display h4 {
            margin-top: 0;
            color: #0056b3;
        }

        .availability-summary {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Hospedajes Cartagena</h1>
        <p>Encuentra tu alojamiento perfecto</p>
    </header>
    
    <nav>
        <ul id="nav-menu">
            <li><a href="#" onclick="showSection('home')">Inicio</a></li>
            <li><a href="#" onclick="showSection('properties')">Propiedades</a></li>
            <li><a href="#" onclick="showSection('publish')">Publicar</a></li>
            <li id="register-nav-item"><a href="#" onclick="showSection('register')">Registrarse</a></li>
            <li id="login-nav-item"><a href="#" onclick="showSection('login')">Iniciar Sesión</a></li>
            <li id="profile-nav-item" class="hidden"><a href="#" onclick="showSection('profile')">Mi Perfil</a></li>
            <li id="logout-nav-item" class="hidden"><a href="#" onclick="logout()" class="logout-btn">Cerrar Sesión</a></li>
            <li><a href="#" onclick="showSection('contact')">Contacto</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <!-- Sección de Inicio -->
        <section id="home-section">
            <h2 class="section-title">Bienvenido a Hospedajes Cartagena</h2>
            <p>Encuentra las mejores opciones de alojamiento en la hermosa Cartagena de Indias.</p>
            
            <h3>Propiedades destacadas</h3>
            <div class="property-list" id="featured-properties">
                <p>Cargando propiedades destacadas...</p>
            </div>
        </section>
        
        <!-- Sección de Propiedades -->
        <section id="properties-section" class="hidden">
            <h2 class="section-title">Todas las Propiedades</h2>
            <div class="property-list" id="all-properties">
                <p>Cargando propiedades...</p>
            </div>
        </section>
        
        <!-- Detalle de Propiedad -->
        <section id="property-detail-section" class="hidden">
            <button class="back-button" onclick="showSection('properties')">← Volver a propiedades</button>
            <div id="property-detail-content">
                <!-- Contenido dinámico -->
            </div>
        </section>
        
        <!-- Publicar Propiedad -->
        <section id="publish-section" class="hidden">
            <h2 class="section-title">Publicar tu Propiedad</h2>
            <div id="publish-login-message" class="hidden">
                <p>Debes iniciar sesión para publicar una propiedad.</p>
                <button onclick="showSection('login')">Iniciar Sesión</button>
            </div>
            
            <div id="publish-form-container" class="hidden">
                <form id="publish-form" class="form-container">
                    <h3>Información Básica</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="property-type">Tipo de propiedad:</label>
                            <select id="property-type" required>
                                <option value="">Seleccione...</option>
                                <option value="apartment">Apartamento</option>
                                <option value="house">Casa</option>
                                <option value="room">Habitación</option>
                                <option value="hostel">Hostal</option>
                                <option value="hotel">Hotel</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-operation">Tipo de operación:</label>
                            <select id="property-operation" required>
                                <option value="rent">Arriendo</option>
                                <option value="sale">Venta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-title">Título del anuncio:</label>
                        <input type="text" id="property-title" placeholder="Ej: Acogedor apartamento en Bocagrande con vista al mar" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-description">Descripción detallada:</label>
                        <textarea id="property-description" rows="6" placeholder="Describe tu propiedad con detalles como distribución, mobiliario, servicios incluidos, etc." required></textarea>
                    </div>
                    
                    <h3>Ubicación</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="property-address">Dirección exacta:</label>
                            <input type="text" id="property-address" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-zone">Zona/Barrio:</label>
                            <select id="property-zone" required>
                                <option value="">Seleccione...</option>
                                <option value="bocagrande">Bocagrande</option>
                                <option value="getsemani">Getsemaní</option>
                                <option value="centro">Centro Histórico</option>
                                <option value="manga">Manga</option>
                                <option value="castillogrande">Castillo Grande</option>
                                <option value="laguito">El Laguito</option>
                                <option value="bocachica">Boca Chica</option>
                                <option value="lacrespa">La Crespa</option>
                                <option value="marbella">Marbella</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>Detalles de la Propiedad</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="property-price">Precio por noche (COP):</label>
                            <input type="number" id="property-price" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-area">Área construida (m²):</label>
                            <input type="number" id="property-area">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="property-rooms">Habitaciones:</label>
                            <input type="number" id="property-rooms" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="property-bathrooms">Baños:</label>
                            <input type="number" id="property-bathrooms" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-capacity">Capacidad (personas):</label>
                            <input type="number" id="property-capacity" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="property-floors">Pisos/Niveles:</label>
                            <input type="number" id="property-floors" min="1" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="property-parking">Parqueaderos:</label>
                            <input type="number" id="property-parking" min="0" value="0">
                        </div>
                    </div>
                    
                    <h3>Comodidades y Servicios</h3>
                    <div class="amenities-container">
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-wifi">
                            <label for="amenity-wifi">Wi-Fi</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-air">
                            <label for="amenity-air">Aire acondicionado</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-pool">
                            <label for="amenity-pool">Piscina</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-kitchen">
                            <label for="amenity-kitchen">Cocina equipada</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-tv">
                            <label for="amenity-tv">Televisión</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-laundry">
                            <label for="amenity-laundry">Lavadora</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-gym">
                            <label for="amenity-gym">Gimnasio</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-elevator">
                            <label for="amenity-elevator">Ascensor</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-security">
                            <label for="amenity-security">Seguridad 24/7</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-beach">
                            <label for="amenity-beach">Acceso a playa</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-terrace">
                            <label for="amenity-terrace">Terraza</label>
                        </div>
                        <div class="amenity-item">
                            <input type="checkbox" id="amenity-breakfast">
                            <label for="amenity-breakfast">Desayuno incluido</label>
                        </div>
                    </div>
                    
                    <h3>Fotos de la Propiedad</h3>
                    <div class="form-group">
                        <label for="property-images">Sube fotos de tu propiedad (Máx. 5 imágenes, 500KB cada una):</label>
                        <input type="file" id="property-images" multiple accept="image/*">
                        <div class="image-preview-container" id="image-preview"></div>
                    </div>
                    
                    <h3>Normas del Alojamiento</h3>
                    <div class="form-group">
                        <label for="property-rules">Normas especiales (opcional):</label>
                        <textarea id="property-rules" rows="3" placeholder="Ej: No se permiten fiestas, No mascotas, No fumar, etc."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-checkin">Horario de check-in:</label>
                        <input type="text" id="property-checkin" placeholder="Ej: 15:00 - 20:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="property-checkout">Horario de check-out:</label>
                        <input type="text" id="property-checkout" placeholder="Ej: Antes de las 11:00">
                    </div>
                    
                    <h3>Disponibilidad</h3>
                    <div class="form-group">
                        <label>Selecciona los días no disponibles (reservados):</label>
                        <div class="availability-options">
                            <label><input type="radio" name="availability" value="all" checked> Todos los días disponibles</label>
                            <label><input type="radio" name="availability" value="custom"> Personalizar disponibilidad</label>
                        </div>
                        
                        <div id="calendar-container" class="hidden">
                            <div class="calendar-navigation">
                                <button type="button" onclick="prevMonth()">←</button>
                                <h4 id="current-month">Mes Actual</h4>
                                <button type="button" onclick="nextMonth()">→</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                            <p class="availability-note">Haz clic en los días para marcarlos como no disponibles (reservados)</p>
                        </div>
                    </div>
                    
                    <button type="submit" id="publish-button">Publicar Propiedad</button>
                </form>
            </div>
        </section>
        
        <!-- Perfil de Usuario -->
        <section id="profile-section" class="hidden">
            <h2 class="section-title">Mi Perfil</h2>
            
            <div class="profile-container">
                <div class="profile-sidebar">
                    <img src="https://ui-avatars.com/api/?name=Usuario&background=0056b3&color=fff" class="user-avatar" id="user-avatar">
                    <h3 id="user-name">Usuario</h3>
                    <p><strong>Teléfono:</strong> <span id="user-phone">No registrado</span></p>
                    <p><strong>Email:</strong> <span id="user-email">No registrado</span></p>
                    <p><strong>Miembro desde:</strong> <span id="user-since">No disponible</span></p>
                    
                    <button onclick="showSection('publish')" style="margin-top: 1rem;">Publicar Nueva Propiedad</button>
                </div>
                
                <div class="profile-content">
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="openProfileTab('properties')">Mis Propiedades</button>
                            <button class="tab-button" onclick="openProfileTab('reservations')">Reservaciones</button>
                            <button class="tab-button" onclick="openProfileTab('settings')">Configuración</button>
                        </div>
                        
                        <div id="properties-tab" class="tab-content active">
                            <h3>Mis Propiedades Publicadas</h3>
                            <div class="user-properties" id="user-properties-list">
                                <p>Cargando propiedades...</p>
                            </div>
                        </div>
                        
                        <div id="reservations-tab" class="tab-content">
                            <h3>Reservaciones Recibidas</h3>
                            <div class="reservations-list" id="reservations-received-list">
                                <p>Cargando reservaciones recibidas...</p>
                            </div>
                            
                            <h3 style="margin-top: 2rem;">Mis Reservaciones</h3>
                            <div class="reservations-list" id="reservations-made-list">
                                <p>Cargando mis reservaciones...</p>
                            </div>
                        </div>
                        
                        <div id="settings-tab" class="tab-content">
                            <h3>Configuración de Cuenta</h3>
                            <form id="profile-form" class="form-container">
                                <div class="form-group">
                                    <label for="profile-name">Nombre completo:</label>
                                    <input type="text" id="profile-name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-phone">Teléfono / WhatsApp:</label>
                                    <input type="tel" id="profile-phone">
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-email">Correo electrónico:</label>
                                    <input type="email" id="profile-email" disabled>
                                </div>
                                
                                <h4>Cambiar Contraseña</h4>
                                <div class="form-group">
                                    <label for="profile-current-password">Contraseña actual:</label>
                                    <input type="password" id="profile-current-password">
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-new-password">Nueva contraseña:</label>
                                    <input type="password" id="profile-new-password">
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-confirm-password">Confirmar nueva contraseña:</label>
                                    <input type="password" id="profile-confirm-password">
                                </div>
                                
                                <button type="submit" id="profile-save-button">Guardar Cambios</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Registro de Usuario -->
        <section id="register-section" class="hidden">
            <h2 class="section-title">Registro de Usuario</h2>
            <form id="register-form" class="form-container">
                <div class="form-group">
                    <label for="register-name">Nombre completo:</label>
                    <input type="text" id="register-name" required>
                </div>
                
                <div class="form-group">
                    <label for="register-phone">Teléfono / WhatsApp (para reservas):</label>
                    <input type="tel" id="register-phone" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">Correo electrónico:</label>
                    <input type="email" id="register-email" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">Contraseña (mínimo 6 caracteres):</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="register-confirm">Confirmar contraseña:</label>
                    <input type="password" id="register-confirm" required>
                </div>
                
                <button type="submit" id="register-button">Registrarse</button>
                <p>¿Ya tienes cuenta? <a href="#" onclick="showSection('login')">Inicia sesión</a></p>
            </form>
        </section>
        
        <!-- Inicio de Sesión -->
        <section id="login-section" class="hidden">
            <h2 class="section-title">Iniciar Sesión</h2>
            <form id="login-form" class="form-container">
                <div class="form-group">
                    <label for="login-email">Correo electrónico:</label>
                    <input type="email" id="login-email" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Contraseña:</label>
                    <input type="password" id="login-password" required>
                </div>
                
                <button type="submit" id="login-button">Iniciar Sesión</button>
                <p>¿No tienes cuenta? <a href="#" onclick="showSection('register')">Regístrate</a></p>
            </form>
        </section>
        
        <!-- Contacto -->
        <section id="contact-section" class="hidden">
            <h2 class="section-title">Contacto</h2>
            <form id="contact-form" class="form-container">
                <div class="form-group">
                    <label for="contact-name">Nombre:</label>
                    <input type="text" id="contact-name" required>
                </div>
                
                <div class="form-group">
                    <label for="contact-email">Correo electrónico:</label>
                    <input type="email" id="contact-email" required>
                </div>
                
                <div class="form-group">
                    <label for="contact-phone">Teléfono:</label>
                    <input type="tel" id="contact-phone">
                </div>
                
                <div class="form-group">
                    <label for="contact-subject">Asunto:</label>
                    <select id="contact-subject" required>
                        <option value="">Seleccione...</option>
                        <option value="question">Consulta</option>
                        <option value="problem">Problema con reserva</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="contact-message">Mensaje:</label>
                    <textarea id="contact-message" rows="4" required></textarea>
                </div>
                
                <button type="submit">Enviar Mensaje</button>
            </form>
        </section>
    </div>
    
    <footer>
        <p>Hospedajes Cartagena &copy; 2023 - Todos los derechos reservados</p>
    </footer>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDm4482FNu-9yMpbdbp4z2Rldy5sPlZjq8",
            authDomain: "kursana-71cc3.firebaseapp.com",
            projectId: "kursana-71cc3",
            storageBucket: "kursana-71cc3.appspot.com",
            messagingSenderId: "74043290336",
            appId: "1:74043290336:web:feb3bfda3ea6867d531685",
            measurementId: "G-YMXCY3VB54"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Estado de la aplicación
        const appState = {
            isLoggedIn: false,
            currentUser: null
        };

        // Variables para el calendario de disponibilidad
        let currentDisplayedMonth = new Date().getMonth();
        let currentDisplayedYear = new Date().getFullYear();
        let selectedUnavailableDates = [];

        // Función para renderizar el calendario
        function renderCalendar(month, year) {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                               "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            calendarGrid.innerHTML = '';
            
            // Encabezados de los días
            const dayNames = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
            dayNames.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });
            
            // Primer día del mes
            const firstDay = new Date(year, month, 1);
            // Último día del mes
            const lastDay = new Date(year, month + 1, 0);
            // Días del mes anterior a mostrar
            const daysFromPrevMonth = firstDay.getDay();
            // Total de días en el mes
            const daysInMonth = lastDay.getDate();
            // Días del próximo mes a mostrar
            const totalCells = Math.ceil((daysFromPrevMonth + daysInMonth) / 7) * 7;
            const daysFromNextMonth = totalCells - (daysFromPrevMonth + daysInMonth);
            
            // Días del mes anterior
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = 0; i < daysFromPrevMonth; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.textContent = prevMonthLastDay - daysFromPrevMonth + i + 1;
                calendarGrid.appendChild(dayElement);
            }
            
            // Días del mes actual
            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day available';
                dayElement.textContent = i;
                
                // Marcar como hoy si corresponde
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                // Verificar si está seleccionado como no disponible
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                if (selectedUnavailableDates.includes(dateStr)) {
                    dayElement.classList.remove('available');
                    dayElement.classList.add('unavailable');
                }
                
                // Agregar evento de clic
                dayElement.addEventListener('click', function() {
                    toggleDateAvailability(dayElement, i, month, year);
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Días del próximo mes
            for (let i = 1; i <= daysFromNextMonth; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.textContent = i;
                calendarGrid.appendChild(dayElement);
            }
        }

        // Función para alternar disponibilidad de una fecha
        function toggleDateAvailability(dayElement, day, month, year) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            
            if (dayElement.classList.contains('available')) {
                // Marcar como no disponible
                dayElement.classList.remove('available');
                dayElement.classList.add('unavailable');
                selectedUnavailableDates.push(dateStr);
            } else if (dayElement.classList.contains('unavailable')) {
                // Marcar como disponible
                dayElement.classList.remove('unavailable');
                dayElement.classList.add('available');
                selectedUnavailableDates = selectedUnavailableDates.filter(d => d !== dateStr);
            }
        }

        // Función para cambiar al mes anterior
        function prevMonth() {
            currentDisplayedMonth--;
            if (currentDisplayedMonth < 0) {
                currentDisplayedMonth = 11;
                currentDisplayedYear--;
            }
            renderCalendar(currentDisplayedMonth, currentDisplayedYear);
        }

        // Función para cambiar al mes siguiente
        function nextMonth() {
            currentDisplayedMonth++;
            if (currentDisplayedMonth > 11) {
                currentDisplayedMonth = 0;
                currentDisplayedYear++;
            }
            renderCalendar(currentDisplayedMonth, currentDisplayedYear);
        }

        // Función para comprimir imágenes
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Tamaño máximo deseado (500KB)
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        const QUALITY = 0.7;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar si es necesario
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a Blob con calidad reducida
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', QUALITY);
                    };
                };
            });
        }

        // Función para convertir imagen a Base64
        async function imageToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onload = () => resolve(reader.result);
            });
        }

        // Función para guardar propiedad en Firestore
        async function saveProperty(propertyData, imageFiles) {
            // Validar número de imágenes
            if (imageFiles.length > 5) {
                throw new Error('Máximo 5 imágenes permitidas');
            }
            
            // Comprimir y convertir imágenes
            const imageUrls = [];
            for (let i = 0; i < imageFiles.length; i++) {
                const file = imageFiles[i];
                if (!file.type.match('image.*')) continue;
                
                let processedFile = file;
                if (file.size > 500000) { // 500KB
                    processedFile = await compressImage(file);
                }
                
                const base64 = await imageToBase64(processedFile);
                imageUrls.push(base64);
            }
            
            // Guardar en Firestore
            const propertyRef = await db.collection('properties').add({
                ...propertyData,
                images: imageUrls,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                ownerId: appState.currentUser.id
            });
            
            return propertyRef.id;
        }

        // Función para cargar propiedades
        async function loadProperties(limit = null) {
            try {
                let query = db.collection('properties').orderBy('createdAt', 'desc');
                if (limit) query = query.limit(limit);
                
                const snapshot = await query.get();
                const properties = [];
                
                snapshot.forEach(doc => {
                    properties.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return properties;
            } catch (error) {
                console.error("Error loading properties:", error);
                throw error;
            }
        }

        // Función para cargar propiedades de un usuario
        async function loadUserProperties(userId) {
            try {
                if (!appState.isLoggedIn || appState.currentUser.id !== userId) {
                    throw new Error("No autorizado para ver estas propiedades");
                }
                
                const snapshot = await db.collection('properties')
                    .where('ownerId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const properties = [];
                snapshot.forEach(doc => {
                    properties.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return properties;
            } catch (error) {
                console.error("Error loading user properties:", error);
                throw error;
            }
        }

        // Función para cargar reservaciones recibidas (para propietarios)
        async function loadReceivedReservations(ownerId) {
            try {
                if (!appState.isLoggedIn) {
                    throw new Error("Debes iniciar sesión para ver reservaciones");
                }
                
                const snapshot = await db.collection('reservations')
                    .where('ownerId', '==', ownerId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const reservations = [];
                snapshot.forEach(doc => {
                    reservations.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return reservations;
            } catch (error) {
                console.error("Error loading received reservations:", error);
                throw error;
            }
        }

        // Función para cargar reservaciones realizadas (para huéspedes)
        async function loadMadeReservations(guestEmail) {
            try {
                if (!appState.isLoggedIn) {
                    throw new Error("Debes iniciar sesión para ver reservaciones");
                }
                
                const snapshot = await db.collection('reservations')
                    .where('guestEmail', '==', guestEmail)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const reservations = [];
                snapshot.forEach(doc => {
                    reservations.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return reservations;
            } catch (error) {
                console.error("Error loading made reservations:", error);
                throw error;
            }
        }

        // Función para mostrar propiedades destacadas
        async function loadFeaturedProperties() {
            const featuredContainer = document.getElementById('featured-properties');
            featuredContainer.innerHTML = '<p>Cargando propiedades destacadas...</p>';
            
            try {
                const properties = await loadProperties(3);
                
                if (properties.length === 0) {
                    featuredContainer.innerHTML = '<p>No hay propiedades destacadas disponibles.</p>';
                    return;
                }
                
                featuredContainer.innerHTML = '';
                
                properties.forEach(property => {
                    featuredContainer.innerHTML += `
                        <div class="property-card">
                            <img src="${property.images[0]}" alt="${property.title}">
                            <h4>${property.title}</h4>
                            <p>${property.rooms || 0} habitaciones, ${property.bathrooms} baño(s)</p>
                            <p><strong>$${property.price.toLocaleString()} / noche</strong></p>
                            <button onclick="showPropertyDetail('${property.id}')">Ver detalles</button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error cargando propiedades destacadas:', error);
                featuredContainer.innerHTML = '<p class="error-message">Error cargando propiedades. Por favor intenta nuevamente.</p>';
            }
        }

        // Función para mostrar todas las propiedades
        async function loadAllProperties() {
            const allContainer = document.getElementById('all-properties');
            allContainer.innerHTML = '<p>Cargando propiedades...</p>';
            
            try {
                const properties = await loadProperties();
                
                if (properties.length === 0) {
                    allContainer.innerHTML = '<p>No hay propiedades disponibles.</p>';
                    return;
                }
                
                allContainer.innerHTML = '';
                
                properties.forEach(property => {
                    allContainer.innerHTML += `
                        <div class="property-card">
                            <img src="${property.images[0]}" alt="${property.title}">
                            <h4>${property.title}</h4>
                            <p>${property.rooms || 0} habitaciones, ${property.bathrooms} baño(s)</p>
                            <p><strong>$${property.price.toLocaleString()} / noche</strong></p>
                            <button onclick="showPropertyDetail('${property.id}')">Ver detalles</button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error cargando propiedades:', error);
                allContainer.innerHTML = '<p class="error-message">Error cargando propiedades. Por favor intenta nuevamente.</p>';
            }
        }

        // Función para mostrar detalle de propiedad
        async function showPropertyDetail(propertyId) {
            try {
                const doc = await db.collection('properties').doc(propertyId).get();
                if (!doc.exists) {
                    throw new Error('Propiedad no encontrada');
                }
                
                const property = doc.data();
                const detailContent = document.getElementById('property-detail-content');
                
                // Buscar información del dueño (solo si el usuario está autenticado)
                let ownerInfo = { name: "Anfitrión", phone: property.phone };
                if (property.ownerId && appState.isLoggedIn) {
                    try {
                        const userDoc = await db.collection('users').doc(property.ownerId).get();
                        if (userDoc.exists) {
                            ownerInfo = userDoc.data();
                            
                            // Ocultar teléfono si no es el propietario
                            if (property.ownerId !== appState.currentUser.id) {
                                ownerInfo.phone = "Contactar al anfitrión";
                            }
                        }
                    } catch (error) {
                        console.error("Error obteniendo info del propietario:", error);
                    }
                }
                
                // Crear galería de imágenes
                let galleryHTML = '';
                if (property.images.length > 1) {
                    galleryHTML = `<div class="property-gallery">`;
                    property.images.forEach((img, index) => {
                        galleryHTML += `<img src="${img}" onclick="changeMainImage(this, 'main-property-image')" alt="Imagen ${index + 1}">`;
                    });
                    galleryHTML += `</div>`;
                }
                
                // Crear lista de comodidades
                let amenitiesHTML = '';
                if (property.amenities && property.amenities.length > 0) {
                    amenitiesHTML = `<div class="amenities-container" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">`;
                    property.amenities.forEach(amenity => {
                        amenitiesHTML += `<div class="amenity-item"><span>✓</span> ${amenity}</div>`;
                    });
                    amenitiesHTML += `</div>`;
                }
                
                // Mostrar disponibilidad si existe
                let availabilityHTML = '';
                if (property.unavailableDates && property.unavailableDates.length > 0) {
                    availabilityHTML = `
                        <div class="availability-display">
                            <h4>Disponibilidad</h4>
                            <div class="availability-summary">
                                <p>Fechas no disponibles (reservadas):</p>
                                <ul>
                                    ${property.unavailableDates.map(date => `<li>${formatDate(date)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                detailContent.innerHTML = `
                    <h2>${property.title}</h2>
                    <img id="main-property-image" src="${property.images[0]}" class="property-detail-image" alt="Imagen principal de ${property.title}">
                    ${galleryHTML}
                    
                    <div class="property-info">
                        <p><strong>Tipo:</strong> ${getPropertyTypeName(property.type)}</p>
                        <p><strong>Operación:</strong> ${property.operation === 'rent' ? 'Arriendo' : 'Venta'}</p>
                        <p><strong>Ubicación:</strong> ${property.address}, ${getZoneName(property.zone)}</p>
                        <p><strong>Precio por noche:</strong> $${property.price.toLocaleString()} COP</p>
                        ${property.area ? `<p><strong>Área construida:</strong> ${property.area} m²</p>` : ''}
                        <p><strong>Habitaciones:</strong> ${property.rooms || 0}</p>
                        <p><strong>Baños:</strong> ${property.bathrooms}</p>
                        <p><strong>Capacidad:</strong> ${property.capacity} personas</p>
                        <p><strong>Pisos:</strong> ${property.floors || 1}</p>
                        <p><strong>Parqueaderos:</strong> ${property.parking || 0}</p>
                        <p><strong>Contacto:</strong> ${ownerInfo.name} - ${formatPhone(ownerInfo.phone)}</p>
                    </div>
                    
                    <h3>Descripción</h3>
                    <div class="property-description">${property.description}</div>
                    
                    <h3>Comodidades</h3>
                    ${amenitiesHTML || '<p>No se han especificado comodidades.</p>'}
                    
                    ${availabilityHTML}
                    
                    <h3>Normas del alojamiento</h3>
                    <div class="property-description">${property.rules || 'No se han especificado normas especiales.'}</div>
                    
                    <div class="property-info">
                        <p><strong>Check-in:</strong> ${property.checkin || 'No especificado'}</p>
                        <p><strong>Check-out:</strong> ${property.checkout || 'No especificado'}</p>
                    </div>
                    
                    ${appState.isLoggedIn ? `
                    <h3>Reservar esta propiedad</h3>
                    <form id="reservation-form" class="reservation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reservation-checkin">Fecha de llegada:</label>
                                <input type="date" id="reservation-checkin" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="reservation-checkout">Fecha de salida:</label>
                                <input type="date" id="reservation-checkout" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reservation-guests">Huéspedes (máx. ${property.capacity}):</label>
                            <input type="number" id="reservation-guests" min="1" max="${property.capacity}" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reservation-name">Nombre completo:</label>
                                <input type="text" id="reservation-name" value="${appState.currentUser.name || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="reservation-phone">Tu teléfono / WhatsApp:</label>
                                <input type="tel" id="reservation-phone" value="${appState.currentUser.phone || ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reservation-email">Tu correo electrónico:</label>
                            <input type="email" id="reservation-email" value="${appState.currentUser.email || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reservation-message">Mensaje adicional (opcional):</label>
                            <textarea id="reservation-message" rows="3"></textarea>
                        </div>
                        
                        <button type="submit">Enviar Solicitud de Reserva</button>
                    </form>
                    ` : '<p>Debes <a href="#" onclick="showSection(\'login\')">iniciar sesión</a> para hacer una reserva.</p>'}
                `;
                
                // Configurar el formulario de reserva si existe
                const reservationForm = document.getElementById('reservation-form');
                if (reservationForm) {
                    reservationForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        sendReservation(property, ownerInfo);
                    });
                }
                
                // Mostrar la sección de detalle
                showSection('property-detail');
            } catch (error) {
                console.error('Error mostrando detalle de propiedad:', error);
                alert('Error al cargar los detalles de la propiedad: ' + error.message);
                showSection('properties');
            }
        }

        // Función para enviar reserva
        async function sendReservation(property, owner) {
            try {
                const checkin = document.getElementById('reservation-checkin').value;
                const checkout = document.getElementById('reservation-checkout').value;
                const guests = document.getElementById('reservation-guests').value;
                const name = document.getElementById('reservation-name').value;
                const phone = document.getElementById('reservation-phone').value;
                const email = document.getElementById('reservation-email').value;
                const message = document.getElementById('reservation-message').value;
                
                // Validar fechas
                if (!checkin || !checkout) {
                    throw new Error('Por favor selecciona las fechas de tu estadía');
                }
                
                // Calcular noches y total
                const date1 = new Date(checkin);
                const date2 = new Date(checkout);
                
                if (date2 <= date1) {
                    throw new Error('La fecha de salida debe ser posterior a la fecha de llegada');
                }
                
                const nights = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
                const total = nights * property.price;
                
                // Formatear fechas
                const formattedCheckin = formatDate(checkin);
                const formattedCheckout = formatDate(checkout);
                
                // Crear mensaje para WhatsApp
                const whatsappMessage = `¡Nueva solicitud de reserva!%0A%0A*🏠 Propiedad:* ${property.title}%0A*📍 Ubicación:* ${property.address}%0A*💰 Precio por noche:* $${property.price.toLocaleString()} COP%0A%0A*📅 Fechas de reserva:*%0A- Llegada: ${formattedCheckin}%0A- Salida: ${formattedCheckout}%0A- Noches: ${nights}%0A*👥 Huéspedes:* ${guests}%0A*💵 Total estimado:* $${total.toLocaleString()} COP%0A%0A*📌 Datos del huésped:*%0A- 👤 Nombre: ${name}%0A- 📞 Teléfono: ${phone}%0A- 📧 Email: ${email}%0A%0A*✉️ Mensaje adicional:*%0A${message || 'Ninguno'}%0A%0A¿Está disponible para estas fechas?`;
                
                // Abrir WhatsApp con el mensaje
                window.open(`https://wa.me/${owner.phone}?text=${whatsappMessage}`, '_blank');
                
                // Guardar la reserva en Firestore
                await db.collection('reservations').add({
                    propertyId: property.id,
                    propertyTitle: property.title,
                    ownerId: property.ownerId,
                    guestName: name,
                    guestPhone: phone,
                    guestEmail: email,
                    checkin: checkin,
                    checkout: checkout,
                    guests: guests,
                    message: message,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Se ha abierto WhatsApp con los datos de tu reserva. Por favor completa el proceso de reserva directamente con el propietario.');
            } catch (error) {
                alert(error.message);
            }
        }

        // Función para cambiar imagen principal en galería
        function changeMainImage(imgElement, mainImageId) {
            const mainImg = document.getElementById(mainImageId);
            mainImg.src = imgElement.src;
        }

        // Función para cargar perfil de usuario
        async function loadUserProfile() {
            if (!appState.isLoggedIn) return;
            
            // Actualizar información del usuario
            document.getElementById('user-name').textContent = appState.currentUser.name;
            document.getElementById('user-phone').textContent = appState.currentUser.phone;
            document.getElementById('user-email').textContent = appState.currentUser.email;
            document.getElementById('user-since').textContent = appState.currentUser.createdAt.toLocaleDateString();
            
            // Actualizar avatar
            const avatar = document.getElementById('user-avatar');
            avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(appState.currentUser.name)}&background=0056b3&color=fff`;
            
            // Cargar propiedades del usuario
            const propertiesList = document.getElementById('user-properties-list');
            propertiesList.innerHTML = '<p>Cargando propiedades...</p>';
            
            try {
                const properties = await loadUserProperties(appState.currentUser.id);
                
                if (properties.length === 0) {
                    propertiesList.innerHTML = '<p>No has publicado ninguna propiedad aún.</p>';
                } else {
                    propertiesList.innerHTML = '';
                    properties.forEach(property => {
                        propertiesList.innerHTML += `
                            <div class="property-card">
                                <img src="${property.images[0]}" alt="${property.title}">
                                <h4>${property.title}</h4>
                                <p>${property.rooms || 0} habitaciones, ${property.bathrooms} baño(s)</p>
                                <p><strong>$${property.price.toLocaleString()} / noche</strong></p>
                                <div class="property-actions">
                                    <button class="edit-btn" onclick="editProperty('${property.id}')">Editar</button>
                                    <button class="delete-btn" onclick="deleteProperty('${property.id}')">Eliminar</button>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error cargando propiedades:', error);
                propertiesList.innerHTML = '<p class="error-message">Error cargando propiedades. Por favor intenta nuevamente.</p>';
            }
            
            // Cargar reservaciones recibidas (como propietario)
            const receivedReservationsList = document.getElementById('reservations-received-list');
            receivedReservationsList.innerHTML = '<p>Cargando reservaciones recibidas...</p>';
            
            try {
                const receivedReservations = await loadReceivedReservations(appState.currentUser.id);
                
                if (receivedReservations.length === 0) {
                    receivedReservationsList.innerHTML = '<p>No tienes reservaciones recibidas.</p>';
                } else {
                    receivedReservationsList.innerHTML = '';
                    receivedReservations.forEach(reservation => {
                        let statusClass = 'status-pending';
                        if (reservation.status === 'confirmed') statusClass = 'status-confirmed';
                        if (reservation.status === 'cancelled') statusClass = 'status-cancelled';
                        
                        receivedReservationsList.innerHTML += `
                            <div class="reservation-card">
                                <h4>${reservation.propertyTitle}</h4>
                                <p><strong>Huésped:</strong> ${reservation.guestName}</p>
                                <p><strong>Teléfono:</strong> ${formatPhone(reservation.guestPhone)}</p>
                                <p><strong>Email:</strong> ${reservation.guestEmail}</p>
                                <p><strong>Fechas:</strong> ${formatDate(reservation.checkin)} - ${formatDate(reservation.checkout)}</p>
                                <p><strong>Huéspedes:</strong> ${reservation.guests}</p>
                                <p><strong>Estado:</strong> <span class="reservation-status ${statusClass}">${getReservationStatusName(reservation.status)}</span></p>
                                <p><strong>Mensaje:</strong> ${reservation.message || 'Ninguno'}</p>
                                <div style="margin-top: 1rem;">
                                    <button onclick="changeReservationStatus('${reservation.id}', 'confirmed')">Confirmar</button>
                                    <button onclick="changeReservationStatus('${reservation.id}', 'cancelled')" class="delete-btn" style="margin-left: 0.5rem;">Cancelar</button>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error cargando reservaciones recibidas:', error);
                receivedReservationsList.innerHTML = '<p class="error-message">Error cargando reservaciones recibidas. Por favor intenta nuevamente.</p>';
            }
            
            // Cargar reservaciones realizadas (como huésped)
            const madeReservationsList = document.getElementById('reservations-made-list');
            madeReservationsList.innerHTML = '<p>Cargando mis reservaciones...</p>';
            
            try {
                const madeReservations = await loadMadeReservations(appState.currentUser.email);
                
                if (madeReservations.length === 0) {
                    madeReservationsList.innerHTML = '<p>No has realizado ninguna reservación.</p>';
                } else {
                    madeReservationsList.innerHTML = '';
                    madeReservations.forEach(reservation => {
                        let statusClass = 'status-pending';
                        if (reservation.status === 'confirmed') statusClass = 'status-confirmed';
                        if (reservation.status === 'cancelled') statusClass = 'status-cancelled';
                        
                        madeReservationsList.innerHTML += `
                            <div class="reservation-card">
                                <h4>${reservation.propertyTitle}</h4>
                                <p><strong>Fechas:</strong> ${formatDate(reservation.checkin)} - ${formatDate(reservation.checkout)}</p>
                                <p><strong>Huéspedes:</strong> ${reservation.guests}</p>
                                <p><strong>Estado:</strong> <span class="reservation-status ${statusClass}">${getReservationStatusName(reservation.status)}</span></p>
                                <p><strong>Mensaje:</strong> ${reservation.message || 'Ninguno'}</p>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error cargando mis reservaciones:', error);
                madeReservationsList.innerHTML = '<p class="error-message">Error cargando mis reservaciones. Por favor intenta nuevamente.</p>';
            }
        }

        // Función para editar propiedad
        async function editProperty(propertyId) {
            try {
                const doc = await db.collection('properties').doc(propertyId).get();
                if (!doc.exists) {
                    throw new Error('Propiedad no encontrada');
                }
                
                const property = doc.data();
                
                // Verificar que el usuario es el propietario
                if (property.ownerId !== appState.currentUser.id) {
                    throw new Error('No tienes permiso para editar esta propiedad');
                }
                
                // Llenar formulario con datos de la propiedad
                document.getElementById('property-type').value = property.type;
                document.getElementById('property-operation').value = property.operation;
                document.getElementById('property-title').value = property.title;
                document.getElementById('property-description').value = property.description;
                document.getElementById('property-address').value = property.address;
                document.getElementById('property-zone').value = property.zone;
                document.getElementById('property-price').value = property.price;
                document.getElementById('property-area').value = property.area || '';
                document.getElementById('property-rooms').value = property.rooms || '';
                document.getElementById('property-bathrooms').value = property.bathrooms;
                document.getElementById('property-capacity').value = property.capacity;
                document.getElementById('property-floors').value = property.floors || 1;
                document.getElementById('property-parking').value = property.parking || 0;
                document.getElementById('property-rules').value = property.rules || '';
                document.getElementById('property-checkin').value = property.checkin || '';
                document.getElementById('property-checkout').value = property.checkout || '';
                
                // Configurar disponibilidad
                if (property.unavailableDates && property.unavailableDates.length > 0) {
                    document.querySelector('input[name="availability"][value="custom"]').checked = true;
                    document.getElementById('calendar-container').classList.remove('hidden');
                    selectedUnavailableDates = property.unavailableDates;
                } else {
                    document.querySelector('input[name="availability"][value="all"]').checked = true;
                    document.getElementById('calendar-container').classList.add('hidden');
                    selectedUnavailableDates = [];
                }
                
                // Renderizar calendario con fechas no disponibles
                renderCalendar(currentDisplayedMonth, currentDisplayedYear);
                
                // Marcar comodidades
                if (property.amenities) {
                    property.amenities.forEach(amenity => {
                        const amenityId = 'amenity-' + amenity.toLowerCase().replace(/ /g, '-');
                        const checkbox = document.getElementById(amenityId);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Mostrar imágenes existentes
                const previewContainer = document.getElementById('image-preview');
                previewContainer.innerHTML = '';
                property.images.forEach(img => {
                    const imgElement = document.createElement('img');
                    imgElement.src = img;
                    imgElement.classList.add('image-preview');
                    previewContainer.appendChild(imgElement);
                });
                
                // Cambiar texto del botón
                document.getElementById('publish-button').textContent = 'Actualizar Propiedad';
                
                // Guardar ID de la propiedad para actualización
                document.getElementById('publish-form').dataset.propertyId = propertyId;
                
                // Mostrar sección de publicación
                showSection('publish');
            } catch (error) {
                console.error('Error editando propiedad:', error);
                alert('Error al cargar la propiedad para edición: ' + error.message);
            }
        }

        // Función para eliminar propiedad
        async function deleteProperty(propertyId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta propiedad? Esta acción no se puede deshacer.')) {
                try {
                    // Verificar que el usuario es el propietario
                    const doc = await db.collection('properties').doc(propertyId).get();
                    if (!doc.exists) {
                        throw new Error('Propiedad no encontrada');
                    }
                    
                    if (doc.data().ownerId !== appState.currentUser.id) {
                        throw new Error('No tienes permiso para eliminar esta propiedad');
                    }
                    
                    await db.collection('properties').doc(propertyId).delete();
                    alert('Propiedad eliminada correctamente');
                    loadUserProfile();
                } catch (error) {
                    console.error('Error eliminando propiedad:', error);
                    alert('Error al eliminar la propiedad: ' + error.message);
                }
            }
        }

        // Función para cambiar estado de reservación
        async function changeReservationStatus(reservationId, status) {
            try {
                // Verificar que el usuario es el propietario de la propiedad reservada
                const reservationDoc = await db.collection('reservations').doc(reservationId).get();
                if (!reservationDoc.exists) {
                    throw new Error('Reservación no encontrada');
                }
                
                if (reservationDoc.data().ownerId !== appState.currentUser.id) {
                    throw new Error('No tienes permiso para modificar esta reservación');
                }
                
                await db.collection('reservations').doc(reservationId).update({
                    status: status
                });
                
                alert(`Reservación ${getReservationStatusName(status)} correctamente`);
                loadUserProfile();
            } catch (error) {
                console.error('Error cambiando estado:', error);
                alert('Error al cambiar el estado de la reservación: ' + error.message);
            }
        }

        // Función para abrir pestaña en perfil
        function openProfileTab(tabId) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Activar la pestaña seleccionada
            document.getElementById(`${tabId}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Función para mostrar sección
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar la sección solicitada
            const section = document.getElementById(`${sectionId}-section`);
            if (section) {
                section.classList.remove('hidden');
                
                // Mostrar/ocultar formulario de publicación según login
                if (sectionId === 'publish') {
                    const loginMessage = document.getElementById('publish-login-message');
                    const formContainer = document.getElementById('publish-form-container');
                    
                    if (appState.isLoggedIn) {
                        loginMessage.classList.add('hidden');
                        formContainer.classList.remove('hidden');
                        // Resetear formulario si no estamos editando
                        if (!document.getElementById('publish-form').dataset.propertyId) {
                            document.getElementById('publish-form').reset();
                            document.getElementById('image-preview').innerHTML = '';
                            document.getElementById('publish-button').textContent = 'Publicar Propiedad';
                            selectedUnavailableDates = [];
                            renderCalendar(new Date().getMonth(), new Date().getFullYear());
                        }
                    } else {
                        loginMessage.classList.remove('hidden');
                        formContainer.classList.add('hidden');
                    }
                }
                
                // Cargar datos según la sección
                if (sectionId === 'home') loadFeaturedProperties();
                if (sectionId === 'properties') loadAllProperties();
                if (sectionId === 'profile') loadUserProfile();
            }
        }

        // Función para actualizar navegación
        function updateNav() {
            const registerItem = document.getElementById('register-nav-item');
            const loginItem = document.getElementById('login-nav-item');
            const profileItem = document.getElementById('profile-nav-item');
            const logoutItem = document.getElementById('logout-nav-item');
            
            if (appState.isLoggedIn) {
                registerItem.classList.add('hidden');
                loginItem.classList.add('hidden');
                profileItem.classList.remove('hidden');
                logoutItem.classList.remove('hidden');
            } else {
                registerItem.classList.remove('hidden');
                loginItem.classList.remove('hidden');
                profileItem.classList.add('hidden');
                logoutItem.classList.add('hidden');
            }
        }

        // Función para cerrar sesión
        function logout() {
            auth.signOut().then(() => {
                appState.isLoggedIn = false;
                appState.currentUser = null;
                alert('Has cerrado sesión correctamente');
                showSection('home');
            }).catch(error => {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión: ' + error.message);
            });
        }

        // Funciones auxiliares
        function getPropertyTypeName(type) {
            const types = {
                'apartment': 'Apartamento',
                'house': 'Casa',
                'room': 'Habitación',
                'hostel': 'Hostal',
                'hotel': 'Hotel'
            };
            return types[type] || type;
        }

        function getZoneName(zone) {
            const zones = {
                'bocagrande': 'Bocagrande',
                'getsemani': 'Getsemaní',
                'centro': 'Centro Histórico',
                'manga': 'Manga',
                'castillogrande': 'Castillo Grande',
                'laguito': 'El Laguito',
                'bocachica': 'Boca Chica',
                'lacrespa': 'La Crespa',
                'marbella': 'Marbella'
            };
            return zones[zone] || zone;
        }

        function getReservationStatusName(status) {
            const statuses = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada'
            };
            return statuses[status] || status;
        }

        function formatPhone(phone) {
            if (!phone) return 'No disponible';
            const cleaned = phone.toString().replace(/\D/g, '');
            return `+${cleaned.substring(0, 2)} ${cleaned.substring(2, 5)} ${cleaned.substring(5, 8)} ${cleaned.substring(8)}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'No especificada';
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        // Manejar cambios en la opción de disponibilidad
        document.querySelectorAll('input[name="availability"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const calendarContainer = document.getElementById('calendar-container');
                if (this.value === 'custom') {
                    calendarContainer.classList.remove('hidden');
                    renderCalendar(currentDisplayedMonth, currentDisplayedYear);
                } else {
                    calendarContainer.classList.add('hidden');
                    selectedUnavailableDates = [];
                }
            });
        });

        // Manejar registro de usuario
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const registerButton = document.getElementById('register-button');
            const originalText = registerButton.textContent;
            registerButton.disabled = true;
            registerButton.innerHTML = '<span class="loading"></span> Registrando...';
            
            try {
                const name = document.getElementById('register-name').value.trim();
                const phone = document.getElementById('register-phone').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                // Validaciones
                if (!name || !phone || !email || !password || !confirm) {
                    throw new Error('Por favor completa todos los campos');
                }
                
                if (password !== confirm) {
                    throw new Error('Las contraseñas no coinciden');
                }
                
                if (password.length < 6) {
                    throw new Error('La contraseña debe tener al menos 6 caracteres');
                }
                
                if (!phone.match(/^[0-9]{10,15}$/)) {
                    throw new Error('Teléfono inválido (10-15 dígitos)');
                }
                
                // Registrar en Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Guardar información adicional en Firestore
                await db.collection('users').doc(user.uid).set({
                    id: user.uid,
                    name,
                    phone,
                    email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Actualizar estado
                appState.isLoggedIn = true;
                appState.currentUser = {
                    id: user.uid,
                    name,
                    phone,
                    email,
                    createdAt: new Date()
                };
                
                updateNav();
                alert('Registro exitoso. Ahora puedes publicar propiedades.');
                showSection('profile');
            } catch (error) {
                console.error('Error en registro:', error);
                
                let errorMessage = 'Error en registro';
                if (error.code) {
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'Este correo ya está registrado';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Correo electrónico inválido';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'La contraseña debe tener al menos 6 caracteres';
                            break;
                        default:
                            errorMessage = error.message || errorMessage;
                    }
                }
                
                alert(errorMessage);
            } finally {
                registerButton.disabled = false;
                registerButton.textContent = originalText;
            }
        });

        // Manejar inicio de sesión
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginButton = document.getElementById('login-button');
            const originalText = loginButton.textContent;
            loginButton.disabled = true;
            loginButton.innerHTML = '<span class="loading"></span> Iniciando sesión...';
            
            try {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    throw new Error('Por favor ingresa tu correo y contraseña');
                }
                
                // Iniciar sesión con Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Obtener información adicional de Firestore
                const doc = await db.collection('users').doc(user.uid).get();
                if (!doc.exists) {
                    throw new Error('Usuario no encontrado');
                }
                
                const userData = doc.data();
                
                // Actualizar estado
                appState.isLoggedIn = true;
                appState.currentUser = {
                    id: user.uid,
                    name: userData.name,
                    phone: userData.phone,
                    email: userData.email,
                    createdAt: userData.createdAt.toDate()
                };
                
                updateNav();
                alert('Inicio de sesión exitoso');
                showSection('profile');
            } catch (error) {
                console.error('Error en inicio de sesión:', error);
                
                let errorMessage = 'Error en inicio de sesión';
                if (error.code) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'Usuario no encontrado';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Contraseña incorrecta';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Correo electrónico inválido';
                            break;
                        default:
                            errorMessage = error.message || errorMessage;
                    }
                }
                
                alert(errorMessage);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = originalText;
            }
        });

        // Manejar publicación de propiedad
        document.getElementById('publish-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const publishButton = document.getElementById('publish-button');
            const originalText = publishButton.textContent;
            publishButton.disabled = true;
            publishButton.innerHTML = '<span class="loading"></span> Publicando...';
            
            try {
                if (!appState.isLoggedIn) {
                    throw new Error('Debes iniciar sesión para publicar una propiedad');
                }
                
                // Obtener valores del formulario
                const type = document.getElementById('property-type').value;
                const operation = document.getElementById('property-operation').value;
                const title = document.getElementById('property-title').value;
                const description = document.getElementById('property-description').value;
                const address = document.getElementById('property-address').value;
                const zone = document.getElementById('property-zone').value;
                const price = parseFloat(document.getElementById('property-price').value);
                const area = document.getElementById('property-area').value ? parseInt(document.getElementById('property-area').value) : null;
                const rooms = document.getElementById('property-rooms').value ? parseInt(document.getElementById('property-rooms').value) : null;
                const bathrooms = parseInt(document.getElementById('property-bathrooms').value);
                const capacity = parseInt(document.getElementById('property-capacity').value);
                const floors = document.getElementById('property-floors').value ? parseInt(document.getElementById('property-floors').value) : 1;
                const parking = document.getElementById('property-parking').value ? parseInt(document.getElementById('property-parking').value) : 0;
                const rules = document.getElementById('property-rules').value;
                const checkin = document.getElementById('property-checkin').value;
                const checkout = document.getElementById('property-checkout').value;
                
                // Obtener comodidades seleccionadas
                const amenities = [];
                if (document.getElementById('amenity-wifi').checked) amenities.push('Wi-Fi');
                if (document.getElementById('amenity-air').checked) amenities.push('Aire acondicionado');
                if (document.getElementById('amenity-pool').checked) amenities.push('Piscina');
                if (document.getElementById('amenity-kitchen').checked) amenities.push('Cocina equipada');
                if (document.getElementById('amenity-tv').checked) amenities.push('Televisión');
                if (document.getElementById('amenity-laundry').checked) amenities.push('Lavadora');
                if (document.getElementById('amenity-gym').checked) amenities.push('Gimnasio');
                if (document.getElementById('amenity-elevator').checked) amenities.push('Ascensor');
                if (document.getElementById('amenity-security').checked) amenities.push('Seguridad 24/7');
                if (document.getElementById('amenity-beach').checked) amenities.push('Acceso a playa');
                if (document.getElementById('amenity-terrace').checked) amenities.push('Terraza');
                if (document.getElementById('amenity-breakfast').checked) amenities.push('Desayuno incluido');
                
                // Validaciones básicas
                if (!type || !title || !description || !address || !zone || !price || !bathrooms || !capacity) {
                    throw new Error('Por favor completa todos los campos requeridos');
                }
                
                if (price <= 0) {
                    throw new Error('El precio debe ser mayor a cero');
                }
                
                // Obtener imágenes
                const imageFiles = document.getElementById('property-images').files;
                const existingImages = Array.from(document.getElementById('image-preview').children)
                    .filter(img => img.tagName === 'IMG' && img.src.startsWith('data:image'))
                    .map(img => img.src);
                
                // Si estamos editando y no hay nuevas imágenes, usar las existentes
                let imagesToUse = existingImages;
                const isEditing = this.dataset.propertyId;
                
                if (!isEditing && (!imageFiles || imageFiles.length === 0)) {
                    throw new Error('Debes subir al menos una imagen de la propiedad');
                }
                
                if (imageFiles && imageFiles.length > 0) {
                    // Comprimir y convertir nuevas imágenes
                    imagesToUse = [];
                    for (let i = 0; i < imageFiles.length; i++) {
                        const file = imageFiles[i];
                        if (!file.type.match('image.*')) continue;
                        
                        let processedFile = file;
                        if (file.size > 500000) { // 500KB
                            processedFile = await compressImage(file);
                        }
                        
                        const base64 = await imageToBase64(processedFile);
                        imagesToUse.push(base64);
                    }
                }
                
                // Obtener fechas no disponibles
                const availabilityOption = document.querySelector('input[name="availability"]:checked').value;
                const unavailableDates = availabilityOption === 'all' ? [] : selectedUnavailableDates;
                
                // Crear objeto de propiedad
                const propertyData = {
                    type,
                    operation,
                    title,
                    description,
                    address,
                    zone,
                    price,
                    bathrooms,
                    capacity,
                    floors,
                    parking,
                    amenities,
                    ownerId: appState.currentUser.id,
                    phone: appState.currentUser.phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    unavailableDates
                };
                
                // Agregar campos opcionales si existen
                if (area) propertyData.area = area;
                if (rooms) propertyData.rooms = rooms;
                if (rules) propertyData.rules = rules;
                if (checkin) propertyData.checkin = checkin;
                if (checkout) propertyData.checkout = checkout;
                
                // Guardar propiedad
                if (isEditing) {
                    // Actualizar propiedad existente
                    await db.collection('properties').doc(this.dataset.propertyId).update({
                        ...propertyData,
                        images: imagesToUse
                    });
                    alert('Propiedad actualizada correctamente');
                } else {
                    // Crear nueva propiedad
                    await db.collection('properties').add({
                        ...propertyData,
                        images: imagesToUse
                    });
                    alert('Propiedad publicada correctamente');
                }
                
                showSection('profile');
            } catch (error) {
                console.error('Error publicando propiedad:', error);
                alert(error.message || 'Error al publicar la propiedad');
            } finally {
                publishButton.disabled = false;
                publishButton.textContent = originalText;
            }
        });

        // Manejar actualización de perfil
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveButton = document.getElementById('profile-save-button');
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="loading"></span> Guardando...';
            
            try {
                const name = document.getElementById('profile-name').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();
                const currentPassword = document.getElementById('profile-current-password').value;
                const newPassword = document.getElementById('profile-new-password').value;
                const confirmPassword = document.getElementById('profile-confirm-password').value;
                
                // Validaciones básicas
                if (!name || !phone) {
                    throw new Error('Por favor completa todos los campos');
                }
                
                if (!phone.match(/^[0-9]{10,15}$/)) {
                    throw new Error('Teléfono inválido (10-15 dígitos)');
                }
                
                // Actualizar información en Firestore
                await db.collection('users').doc(appState.currentUser.id).update({
                    name,
                    phone
                });
                
                // Actualizar contraseña si se proporcionó
                if (currentPassword || newPassword || confirmPassword) {
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        throw new Error('Por favor completa todos los campos de contraseña');
                    }
                    
                    if (newPassword !== confirmPassword) {
                        throw new Error('Las nuevas contraseñas no coinciden');
                    }
                    
                    if (newPassword.length < 6) {
                        throw new Error('La nueva contraseña debe tener al menos 6 caracteres');
                    }
                    
                    // Reautenticar
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        appState.currentUser.email, 
                        currentPassword
                    );
                    
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    
                    // Actualizar contraseña
                    await auth.currentUser.updatePassword(newPassword);
                }
                
                // Actualizar estado
                appState.currentUser.name = name;
                appState.currentUser.phone = phone;
                
                alert('Perfil actualizado correctamente');
                loadUserProfile();
            } catch (error) {
                console.error('Error actualizando perfil:', error);
                
                let errorMessage = 'Error actualizando perfil';
                if (error.code) {
                    switch (error.code) {
                        case 'auth/wrong-password':
                            errorMessage = 'Contraseña actual incorrecta';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'La nueva contraseña debe tener al menos 6 caracteres';
                            break;
                        default:
                            errorMessage = error.message || errorMessage;
                    }
                }
                
                alert(errorMessage);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        });

        // Manejar formulario de contacto
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('contact-name').value;
            const subject = document.getElementById('contact-subject').value;
            
            alert(`Gracias ${name}, tu mensaje sobre "${subject}" ha sido enviado. Nos contactaremos contigo pronto.`);
            showSection('home');
        });

        // Manejar previsualización de imágenes
        document.getElementById('property-images').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            if (files.length > 5) {
                alert('Máximo 5 imágenes permitidas. Se mostrarán las primeras 5.');
            }
            
            const filesToShow = Array.from(files).slice(0, 5);
            
            for (let i = 0; i < filesToShow.length; i++) {
                const file = filesToShow[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('image-preview');
                    previewContainer.appendChild(img);
                }
                
                reader.readAsDataURL(file);
            }
        });

        // Escuchar cambios en autenticación
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Usuario logueado
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        appState.isLoggedIn = true;
                        appState.currentUser = {
                            id: user.uid,
                            name: doc.data().name,
                            phone: doc.data().phone,
                            email: user.email,
                            createdAt: doc.data().createdAt.toDate()
                        };
                    }
                } catch (error) {
                    console.error('Error obteniendo datos de usuario:', error);
                }
            } else {
                // Usuario no logueado
                appState.isLoggedIn = false;
                appState.currentUser = null;
            }
            
            updateNav();
        });

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            showSection('home');
            // Inicializar calendario
            renderCalendar(currentDisplayedMonth, currentDisplayedYear);
        });
    </script>
</body>
</html>
